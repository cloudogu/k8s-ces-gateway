apiVersion: v1
values:
  images:
    controller: registry.k8s.io/ingress-nginx/controller:v1.13.1
    webhook: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.6.1
patches:
  values.yaml:
    global:
      image:
        registry: "{{ registryFrom .images.controller }}"
    ingress-nginx:
      controller:
        image:
          image: "{{ repositoryFrom .images.controller }}"
          tag: "{{ tagFrom .images.controller }}"
        extraInitContainers:
          - name: patch-nginx-template
            image: "{{ registryFrom .images.controller }}/{{ repositoryFrom .images.controller }}:{{ tagFrom .images.controller }}"
            volumeMounts:
              - name: nginx-template
                mountPath: /work
            command:
              - /bin/sh
              - -c
              - |
                set -euo pipefail
                cp /etc/nginx/template/nginx.tmpl /work/nginx.tmpl
                includeCesConfig='  include /etc/nginx/ces-config/*.conf;'
                serverIncludesKey='{{ if not (empty \$server\.ServerSnippet) }}'
                sed -i "/${serverIncludesKey}/i ${includeCesConfig}" /work/nginx.tmpl
        admissionWebhooks:
          patch:
            image:
              image: "{{ repositoryFrom .images.webhook }}"
              tag: "{{ tagFrom .images.webhook }}"
